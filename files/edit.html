<!DOCTYPE html>
<html lang='en'>

<head>
    <title>text adventure game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        span {
            cursor: pointer;
            text-decoration: underline;
        }

        button {
            padding: 0px 0px;
        }

        .nobullet {
            list-style: none;
        }

        li {
            line-height: 300%;
        }

        iframe {
            border: 1px solid black;
        }
    </style>
</head>

<body class="game">
    <p>Locations</p>
    <ul class="location">
        <li class="nobullet"><button onclick='add(this.parentElement.parentElement)'>Add a location</button></li>
        %s
    </ul>
    <p>Objects</p>
    <ul class="object">
        <li class="nobullet"><button onclick='add(this.parentElement.parentElement)'>Add an object</button></li>
        %s
    </ul>
    <button onclick='remove(this)'>Delete this game</button>
    <p></p>
    <iframe onload="this.height = this.contentWindow.document.body.scrollHeight + 24;" src="/start?game=%s"></iframe>
</body>
<script>
    const game = '%d';
    var opened = new Set();
    function expand(element) {
        if (opened.has(element)) {
            const lists = element.getElementsByTagName('ul');
            if (lists[0].hidden) {
                for (const elem of lists) elem.hidden = false;
            } else {
                for (const elem of lists) elem.hidden = true;
            }
        } else {
            opened.add(element);
            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) element.innerHTML += this.responseText;
            }
            xhttp.open("GET",
                "/expand?game=" + encodeURIComponent(game) +
                "&type=" + element.parentElement.className +
                "&id=" + element.id, true);
            xhttp.send();
        }
    }

    function add(element) {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) element.innerHTML += this.responseText;
        }
        xhttp.open("POST", "/add", true);
        if (element.className == "action") {
            xhttp.send(
                "game=" + game +
                "&type=action&obj=" + element.parentElement.id);
        } else {
            const name = encodeURIComponent(prompt(`Choose a name for the ${element.className}.`, ""));
            if (name == "null" || name == "") return;
            if (element.className == "location") {
                const description = encodeURIComponent(prompt(`Choose a description for the ${element.className}.`, ""));
                if (description == "null" || description == "") return;
                xhttp.send(
                    "game=" + game +
                    "&type=location&name=" + name +
                    "&description=" + description);
            } else if (element.className == "object") {
                xhttp.send(
                    "game=" + game +
                    "&type=object&name=" + name +
                    "&location=" + element.parentElement.id);
            }
        }
    }

    function remove(element) {
        var text =
            "Are you sure you want to delete this " +
            element.parentElement.className + "? This operation cannot be undone";
        if (confirm(text)) {
            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 202) {
                        element.remove();
                    } else if (this.status == 410) {
                        window.location.replace("/");
                    }
                }
            }
            xhttp.open("DELETE",
                "/remove?game=" + encodeURIComponent(game) +
                "&type=" + element.parentElement.className +
                "&id=" + element.id, true);
            xhttp.send();
        }
    }

    function rename(element) {
        const elem = element.getElementsByTagName('span')[0];
        const text = elem.innerHTML;
        elem.innerHTML = `<input value="${elem.innerText.replace(/\"/g, '&quot;')}" onblur="end_rename(this);" onkeypress="if (event.key == 'Enter') end_rename(this);">`;
        elem.getElementsByTagName('input')[0].select();
    }

    function end_rename(element) {
        const text = element.value;
        const xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/rename");
        xhttp.send(
            "id=" + element.parentElement.parentElement.id +
            "&name=" + encodeURIComponent(text) +
            "&game=" + game +
            "&type=" + element.parentElement.parentElement.parentElement.className);
        element.outerHTML = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function make_start(element) {
        const xhttp = new XMLHttpRequest();
        xhttp.open("POST", `/setstart`);
        xhttp.send(`id=${element.id}&game=${game}`);
        const old_start = document.getElementsByClassName('start')[0];
        old_start.className = "";
        old_start.getElementsByTagName("button")[2].hidden = false;
        element.className = 'start';
        element.getElementsByTagName('button')[2].hidden = true;
    }

    function change_description(element) {
        const xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/changedescription");
        xhttp.send(`game=${game}&id=${element.parentElement.parentElement.parentElement.id}&description=${encodeURIComponent(element.value)}`);
    }

    function change_item(element) {
        const xhttp = new XMLHttpRequest();
        xhttp.open("POST", '/changeitem');
        xhttp.send(`game=${game}&id=${element.parentElement.parentElement.id}&newitem=${element.value}`);
    }
</script>

</html>