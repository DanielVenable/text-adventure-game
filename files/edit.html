<!DOCTYPE html>
<html lang='en'>

<head>
	<title>%s | Text Adventure Game Creator</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<link rel="stylesheet" href="navbar.css">
	<style>
		button {
			padding: 0;
		}

		li {
			margin-top: 1em;
		}

		#game + * {
			display: flex;
			flex-direction: column;
		}

		iframe, #super {
			border: 1px solid black;
		}

		#super {
			border-top: 0;
			padding: 3px;
		}

		#super > * {
			margin: 5px;
		}

		.container {
			display: flex;
			flex-wrap: wrap;
		}

		div.textarea {
			overflow-y: auto;
			border: 1px solid black;
			width: fit-content;
			height: 5em;
			resize: both;
			padding: 0.5em;
			margin-top: 1em;
		}

		[data-type="action-description"] {
			margin: 1em 0.5em 1em 0;
		}

		#join-link {
			text-decoration: underline;
		}

		.container > * {
			margin: 10px;
		}

		.names > :not(.help) {
			margin-left: 0.5em;
			margin-right: 0.5em;
		}

		.names > button {
			text-decoration: underline;
			cursor: pointer;
			background-color: transparent;
			border: 0;
			font: inherit;
		}

		.names {
			display: flex;
			align-items: center;
			flex-wrap: wrap;
			margin-top: 5px;
			margin-bottom: 5px;
		}

		.names::before {
			content: "Alternate names:";
		}

		.path-names > * {
			display: block;
			margin-top: 5px;
		}

		.path-names > button {
			text-decoration: underline;
			cursor: pointer;
			background-color: transparent;
			border: 0;
			font: inherit;
		}

		.path-names > ::before {
			content: "go ";
		}

		.path-names > .flex > input {
			margin-left: 5px;
		}

		.help {
			background-image: url(/help-icon.svg);
			background-size: 1em;
			width: 1em;
			height: 1em;
		}

		.help + div {
			position: relative;
		}

		.help + div > div {
			display: none;
		}

		.help:hover + div > div {
			display: block;
			position: absolute;
			border: 1px solid black;
			background-color: rgb(229, 255, 136);
			border-radius: 5px;
			padding: 3px;
			width: 200px;
		}

		.flex {
			display: flex;
			align-items: center;
		}

		.flex > * {
			margin-right: 5px;
		}

		[data-type="action"] .insert-type::after {
			content: "action.";
		}

		[data-type="grab"] .insert-type::after {
			content: "pick up action.";
		}

		[data-type="path"] .insert-type::after {
			content: "path.";
		}

		[data-type="dialog"] .insert-type::after {
			content: "talk to action."
		}

		li > button:not(.link) {
			margin-left: 1em;
		}

		.location-selectable .group {
			font-weight: bold;
		}

		input.default {
			font-style: italic;
		}

		.add-button > button + div {
			position: relative;
		}

		.add-button > button {
			margin-right: 0;
		}

		.add-button > button + div > div {
			display: none;
		}

		.add-button > button:hover + div > div,
		.add-button > button       + div > div:hover {
			display: grid;
			position: absolute;
			grid-template-columns: auto auto auto;
			grid-column-gap: 5px;
			align-items: center;
			top: -29px;
		}

		[data-type="object"] > li > div, [data-type="location"] > li > div, ul {
    		margin-bottom: 1em;
		}

		[hidden] {
			display: none;
		}
	</style>
</head>

<body>
	%s
	<div class="container">
		<div id="game">
			<div class="flex">
				<textarea id="start-text" maxlength="65535">%s</textarea>
				<span class="help"></span>
				<div>
					<div>
						Put the text to be shown at the start of a game here.
					</div>
				</div>
			</div>
			<h3>Locations</h3>
			<div class="flex">
				<button data-type="add">Add a location</button>
				<span class="help"></span>
				<div>
					<div>
						Locations are places the player can be in.
					</div>
				</div>
			</div>
			<ul data-type="location">%s</ul>
			<h3>Objects</h3>
			<div class="flex">
				<button data-type="add">Add an object</button>
				<span class="help"></span>
				<div>
					<div>
						An object is a thing the player can interact with.
						Create the object under the location you want it in.
						<p></p>
						Here is where you put objects that aren't in any location.
						They can be used in states, or moved via location or inventory effects.
					</div>
				</div>
			</div>
			<ul data-type="object">
				%s
			</ul>
			<button data-type="delete">Delete this game</button>
		</div>
		<div>
			<iframe src="/start?game=%s" title="Play your game"></iframe>
			<div id="super">
				<div>
					<button data-type="teleport" disabled>Teleport to </button>
					<select class="location-select"></select>
				</div>
				<div>
					<button data-type="aquire" disabled>Aquire a </button>
					<select class="object-select"></select>
				</div>
				<div>
					<select class="object-select location-selectable"></select>
					<button data-type="state" disabled> becomes state </button>
					<select disabled></select>
				</div>
				<div>
					<select class="object-select"></select>
					<button data-type="move" disabled> moves to </button>
					<select class="location-select"></select>
				</div>
			</div>
		</div>
		%s
	</div>
	<div hidden>
		<div id="location">
			<li>
				<button class="link"></button>
				<button data-type="delete">delete</button>
				<button data-type="rename">rename</button>
				<button data-type="make-start">make start</button>
			</li>
		</div>
		<div id="object">
			<li>
				<button class="link"></button>
				<button data-type="delete">delete</button>
				<button data-type="rename">rename</button>
			</li>
		</div>
		<div id="constraint">
			<li>
				<select class="object-select location-selectable"></select>
				must be in state
				<input disabled size="10" maxlength="255">
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="effect">
			<li>
				<select class="object-select location-selectable"></select>
				goes in state
				<input disabled size="10" maxlength="255">
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="location-constraint">
			<li>
				<select class="object-select"></select>
				must be in <select class="location-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="location-effect">
			<li>
				<select class="object-select"></select>
				goes in <select class="location-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="inventory-constraint">
			<li>
				You
				<select class="noupdate">
					<option value="1">
						must have
					</option>
					<option value="0">
						must not have
					</option>
				</select>
				<select class="object-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="inventory-effect">
			<li>
				You get
				<select class="object-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="expanded-location">
			<div class="textarea">
				<div class="flex">
					<span class="help"></span>
					<div>
						<div>
							Here is where you put a description of the location.
							Click the "+" buttons to add a part of the description.
							Put some text in the textbox. You can add constraints to
							each part of the description to choose what parts are shown.
						</div>
					</div>
				</div>
				<p>
					<button data-type="add-description-part">+</button>
				</p>
			</div>
			<div class="flex">
				<button data-type="add">Add an object</button>
				<span class="help"></span>
				<div>
					<div>
						An object is a thing the player can interact with.
						Create the object under the location you want it in.
					</div>
				</div>
			</div>
			<ul data-type="object"></ul>
			<div class="flex">
				<button data-type="add">Add a path</button>
				<span class="help"></span>
				<div>
					<div>
						A path is a way to get from one location to another.
						Create the path in the location the path starts in,
						then choose where it leads using the select box.
						The player can use a path by typing: "go to <i>place</i>",
						where <i>place</i> is the name of a location.
						Paths are one way;
						if you want the player to be able to go back, you will need two paths.
						If you want a path that doesn't lead anywhere, leave the select box blank.
					</div>
				</div>
			</div>
			<ul data-type="path"></ul>
		</div>
		<div id="expanded-object">
			<div class="names">
				<input maxlength="255">
				<span class="help"></span>
				<div>
					<div>
						Here is where you put alternate names for an object.
						Any time the player can refer to an object using its name,
						they can refer to it using one of these alternate names.
					</div>
				</div>
			</div>
			<div class="flex">
				<button data-type="add">Add an action</button>
				<span class="help"></span>
				<div>
					<div>
						An action is a way for the player to interact with objects.
						Actions either use one object or two.
						<p>
							If it uses one, create the action under the object it uses.
							The player will activate it by typing: "use <i>object</i>",
							where <i>object</i> is the name of the object it uses.
							The object must be either in the location they are in or in their inventory.
						</p>
						If the action uses two objects,
						the player will activate it by typing: "use <i>object 1</i> on <i>object 2</i>"
						They will need object 1 in their inventory and
						object 2 in either their inventory or the location they are in.
						Create the action under object 1, and set the select box to object 2.
					</div>
				</div>
			</div>
			<ul data-type="action"></ul>
			<div class="flex">
				<button data-type="add">Add a pick up action</button>
				<span class="help"></span>
				<div>
					<div>
						Pick up actions allow the player to pick up an object.
						Create one under the object to be picked up.
						The player can pick up the object by typing:
						"pick up <i>object</i>", "grab <i>object</i>", or "get <i>object</i>",
						where <i>object</i> is the name of the object.
						It will add it to their inventory.
						If you don't want that to happen, deselect the "success" checkbox.
					</div>
				</div>
			</div>
			<ul data-type="grab"></ul>
			<div class="flex">
				<button data-type="add">Add a talk to action</button>
				<span class="help"></span>
				<div>
					<div>
						Talk to actions allow the player to talk to something.
						Create one under the object they can talk to.
						The player can talk to it by typing: "talk to <i>object</i>",
						where <i>object</i> is the name of the object.
					</div>
				</div>
			</div>
			<ul data-type="dialog"></ul>
		</div>
		<div id="expanded-action">
			<div class="flex">
				<textarea data-type="action-description" maxlength="255"></textarea>
				<span class="help"></span>
				<div>
					<div class="insert-type">
						Here is where you put text describing what happens
						when you use the <!-- css inserts type here -->
					</div>
				</div>
			</div>
			<div class="add-button flex">
				<button>Add a constraint &gt;</button>
				<div>
					<div>
						<button data-type="constraint">Regular</button>
						<span class="help"></span>
						<div>
							<div>
								Regular constraints check the state of something.
								Choose an object or location from the select box,
								then choose the state it has to be in.
								"default" is the state it starts in.
							</div>
						</div>
						<button data-type="location-constraint">Location</button>
						<span class="help"></span>
						<div>
							<div>
								Location constraints check where an object is.
								Select an object, then choose the location it has to be in.
							</div>
						</div>
						<button data-type="inventory-constraint">Inventory</button>
						<span class="help"></span>
						<div>
							<div>
								Inventory constraints check whether something
								is in the player's inventory. Choose an object,
								and choose whether they must or must not have it.
							</div>
						</div>
					</div>
				</div>
				<span class="help"></span>
				<div>
					<div>
						Constraints restrict whether an
						action, pick up action, or path is allowed to happen.
						It can only happen if it passes all the constraints.
					</div>
				</div>
			</div>
			<div class="add-button flex">
				<button>Add an effect &gt;</button>
				<div>
					<div>
						<button data-type="effect">Regular</button>
						<span class="help"></span>
						<div>
							<div>
								Regular effects change the state of something.
								Choose an object or location from the select box,
								then choose the state it goes in.
								"default" is the state it starts in.
							</div>
						</div>
						<button data-type="location-effect">Location</button>
						<span class="help"></span>
						<div>
							<div>
								Location constraints change where an object is.
								Select an object, then choose the location it goes in.
								These can be used to remove something from the player's inventory.
							</div>
						</div>
						<button data-type="inventory-effect">Inventory</button>
						<span class="help"></span>
						<div>
							<div>
								Inventory constraints add something to the player's inventory.
								Select the object they get. If you want the player to lose an
								object instead, use a location effect.
							</div>
						</div>
					</div>
				</div>
				<span class="help"></span>
				<div>
					<div>
						Effects change the state of your game when the
						player uses an action, pick up action, or path.
					</div>
				</div>
			</div>
			<ul data-type="constraint"></ul>
			<ul data-type="effect"></ul>
			<ul data-type="location-constraint"></ul>
			<ul data-type="location-effect"></ul>
			<ul data-type="inventory-constraint"></ul>
			<ul data-type="inventory-effect"></ul>
		</div>
		<div id="description">
			<div class="description">
				<div class="add-button flex">
					<button>Add a constraint &gt;</button>
					<div>
						<div>
							<button data-type="constraint">Regular</button>
							<span class="help"></span>
							<div>
								<div>
									Regular constraints check the state of something.
									Choose an object or location from the select box,
									then choose the state it has to be in.
									"default" is the state it starts in.
								</div>
							</div>
							<button data-type="location-constraint">Location</button>
							<span class="help"></span>
							<div>
								<div>
									Location constraints check where an object is.
									Select an object, then choose the location it has to be in.
								</div>
							</div>
							<button data-type="inventory-constraint">Inventory</button>
							<span class="help"></span>
							<div>
								<div>
									Inventory constraints check whether something
									is in the player's inventory. Choose an object,
									and choose whether they must or must not have it.
								</div>
							</div>
						</div>
					</div>
					<span class="help"></span>
					<div>
						<div>
							Constraints can restrict whether a part of a description is shown.
							It is shown only if it passes all the constraints.
						</div>
					</div>
				</div>
				<ul data-type="constraint"></ul>
				<ul data-type="location-constraint"></ul>
				<ul data-type="inventory-constraint"></ul>
				<textarea maxlength="255"></textarea>
				<button data-type="remove-description-part">delete</button>
			</div>
			<p><button data-type="add-description-part">+</button></p>
		</div>
		<div id="action">
			<li>
				<button class="link"></button>
				<select class="object-select"></select>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="grab">
			<li>
				<button class="link"></button>
				<label><input type="checkbox" data-type="success-checkbox">success</label>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="dialog">
			<li>
				<button class="link"></button>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="path">
			<li>
				<button class="link">go to </button>
				<select class="location-select"></select>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="path-names">
			<div class="path-names">
				<span class="flex">
					<input maxlength="255">
					<span class="help"></span>
					<div>
						<div>
							Here is where you put alternate commands to use a path.
							Any of the commands listed here will let you use this path.
						</div>
					</div>
				</span>
			</div>
		</div>
	</div>
</body>

<script>
	'use strict';

	const game_view = document.getElementById('game');
	const opened = new WeakSet;

	const all_objects = {};
	all_objects.load = new Promise(resolve => all_objects.trigger = resolve);

	ajax('GET', '/all-objects').then(({ response }) => {
		all_objects.trigger();
		const selects = document.querySelectorAll('.object-select');
		for (const select of selects) select.append(document.createElement('option'));
		let current;
		for (const { id, name, loc_id, loc_name } of response) {
			if (current !== loc_id && loc_id !== null) {
				current = loc_id;
				for (const select of selects) {
					let elem;
					if (select.classList.contains('location-selectable')) {
						elem = document.createElement('option');
						elem.classList.add('group');
						elem.text = loc_name;
						elem.value = 'l'+loc_id;
					} else {
						elem = document.createElement('optgroup');
						elem.label = loc_name;
						elem.dataset.id = loc_id;
					}
					select.append(elem);
				}
				create_datalist(`location-${loc_id}-states`);
			}
			if (id === null) continue;
			for (const select of selects) {
				const elem = document.createElement('option');
				elem.value = id;
				const location_selectable = select.classList.contains('location-selectable');
				elem.text = location_selectable && loc_id !== null ? '   ' + name : name;
				(loc_id === null || location_selectable ? select : select.lastChild).append(elem);
			}
			create_datalist(`object-${id}-states`);
		}

		ajax('GET', '/all-states').then(states => {
			for (const { name, obj, loc } of states.response) {
				add_state(name, obj ?
					`object-${obj}-states` : `location-${loc}-states`);
			}
		});
	});

	function create_datalist(id) {
		const datalist = document.createElement('datalist');
		const option = document.createElement('option');
		option.text = 'default';
		datalist.append(option);
		datalist.id = id;
		document.querySelector('body > div[hidden]').append(datalist);
	}

	function add_state(name, id) {
		if (name === null) return;
		const list = document.getElementById(id);
		for (const option of list.options) {
			if (option.text === name) return;
		}
		const elem = document.createElement('option');
		elem.text = name;
		list.append(elem);
	}

	{
		const locations = document.querySelectorAll('ul[data-type="location"] > li');
		for (const select of document.querySelectorAll('.location-select')) {
			select.append(document.createElement('option'));
			for (const location of locations) {
				const elem = document.createElement('option');
				elem.value = location.dataset.id;
				elem.text = location.children[0].textContent;
				select.append(elem);
			}
		}
	}

	game_view.addEventListener('click', async event => {
		const path = event.composedPath();
		if (path[0] instanceof HTMLButtonElement) {
			if (path[0].firstChild instanceof HTMLInputElement) return;
			if (path[0].classList.contains('link')) {
				if (opened.has(path[1])) {
					for (let i = 0, do_hide = false; i < path[1].childElementCount; i++) {
						if (!do_hide) {
							do_hide = path[1].children[i] instanceof HTMLDivElement ||
								path[1].children[i] instanceof HTMLParagraphElement;
						}
						if (do_hide) {
							path[1].children[i].hidden = !path[1].children[i].hidden;
						}
					}
				} else {
					opened.add(path[1]);
					const result = await ajax('GET', '/expand', {
						type: path[2].dataset.type,
						id: path[1].dataset.id
					});
					await all_objects.load;
					if (path[2].dataset.type === 'location') {
						const [description, objects, paths] = result.response;
						const location_elem = clone('expanded-location');
						for (const description_part of description) {
							const description_elem = clone('description');
							description_elem[0].dataset.id = description_part[0].id;
							description_elem[0].querySelector('textarea').value =
								description_part[0].text;
							for (const { obj, loc, name, loc_obj, location, inv_obj, have_it }
									of description_part) {
								if (obj || loc) {
									const elem = clone('constraint')[0];
									elem.querySelector('select').value = elem.dataset.id =
										obj || `l${loc}`;
									const input = elem.querySelector('input');
									if (name === null) {
										input.value = 'default';
										input.classList.add('default');
									} else input.value = name;
									input.disabled = false;
									input.setAttribute('list', obj ?
										`object-${obj}-states` : `location-${loc}-states`);
									description_elem[0].children[1].append(elem);
								}
								if (loc_obj) {
									const elem = clone('location-constraint')[0];
									elem.querySelector('.location-select').value =
										elem.dataset.id = loc_obj;
									elem.querySelector('.object-select').value = location;
									description_elem[0].children[2].append(elem);
								}
								if (inv_obj) {
									const elem = clone('inventory-constraint')[0];
									elem.querySelector('.object-select').value =
										elem.dataset.id = inv_obj;
									elem.querySelector('select').value = +have_it;
									description_elem[0].children[3].append(elem);
								}
							}
							location_elem[0].append(...description_elem);
						}

						for (const { name, id } of objects) {
							const elem = clone('object')[0];
							elem.dataset.id = id;
							elem.children[0].textContent = name;
							location_elem[2].append(elem);
						}

						for (const { id, end, win } of paths) {
							const elem = clone('path')[0];
							elem.dataset.id = id;
							elem.querySelector('.location-select').value = end;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `path-${id}`;
								if (input.value == win) input.checked = true;
							}
							location_elem[4].append(elem);
						}
						path[1].append(...location_elem);
					} else if (path[2].dataset.type === 'object') {
						const [actions, grab, dialogs, names] = result.response;
						const object_elem = clone('expanded-object');
						for (const { id, obj2, win } of actions) {
							const elem = clone('action')[0];
							elem.dataset.id = id;
							elem.querySelector('.link').textContent = `use ${path[0].textContent} on `;
							elem.querySelector('select').value = obj2;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `action-${id}`;
								if (input.value == win) input.checked = true;
							}
							object_elem[2].append(elem);
						}
						for (const { id, success, win } of grab) {
							const elem = clone('grab')[0];
							elem.dataset.id = id;
							elem.querySelector('.link').textContent = `pick up ${path[0].textContent}`;
							if (success) elem.querySelector('input[type="checkbox"]').checked = true;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `grab-${id}`;
								if (input.value == win) input.checked = true;
							}
							object_elem[4].append(elem);
						}
						for (const { id, win } of dialogs) {
							const elem = clone('dialog')[0];
							elem.dataset.id = id;
							elem.querySelector('.link').textContent = `talk to ${path[0].textContent}`;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `dialog-${id}`;
								if (input.value == win) input.checked = true;
							}
							object_elem[6].append(elem);
						}
						for (const { name } of names) {
							const elem = document.createElement('button');
							elem.textContent = name;
							object_elem[0].insertBefore(elem, object_elem[0].querySelector('input'));
						}

						path[1].append(...object_elem);
					} else {
						const [constraints, effects,
							location_constraints, location_effects, inventory_constraints,
							inventory_effects, text, path_names] = result.response;
						const action_elem = clone('expanded-action');
						action_elem[0].children[0].value = text;
						for (const is_constraint of [true, false]) {
							for (const { obj, loc, name } of
									is_constraint ? constraints : effects) {
								const elem = clone(is_constraint ? 'constraint' : 'effect')[0];
								elem.querySelector('select').value = elem.dataset.id =
									obj || 'l'+loc;
								const input = elem.querySelector('input');
								if (name === null) {
									input.value = 'default';
									input.classList.add('default');
								} else input.value = name;
								input.disabled = false;
								input.setAttribute('list', obj ?
									`object-${obj}-states` : `location-${loc}-states`);
								action_elem[is_constraint ? 5 : 6].append(elem);
							}
							for (const { obj, location } of
									is_constraint ? location_constraints : location_effects) {
								const elem = clone(`location-${
									is_constraint ? 'constraint' : 'effect'}`)[0];
								elem.dataset.id = obj;
								elem.querySelector('.object-select').value = obj;
								elem.querySelector('.location-select').value = location;
								action_elem[is_constraint ? 7 : 8].append(elem);
							}
						}
						for (const { obj, have_it } of inventory_constraints) {
							const elem = clone('inventory-constraint')[0];
							elem.dataset.id = obj;
							elem.querySelector('select').value = +have_it;
							elem.querySelector('.object-select').value = obj;
							action_elem[9].append(elem);
						}
						for (const { obj } of inventory_effects) {
							const elem = clone('inventory-effect')[0];
							elem.dataset.id = obj;
							elem.querySelector('.object-select').value = obj;
							action_elem[10].append(elem);
						}

						if (path[2].dataset.type === 'path') {
							const elem = clone('path-names')[0];
							const ref = elem.querySelector('span');
							for (const text of ['', 'to the ']) {
								const { options, selectedIndex } = path[0].nextElementSibling;
								const span = document.createElement('span');
								if (selectedIndex < 1) span.hidden = true;
								else span.textContent = text + options[selectedIndex].text;
								elem.insertBefore(span, ref);
							}
							for (const { name } of path_names) {
								const button = document.createElement('button');
								button.textContent = name;
								elem.insertBefore(button, ref);
							}
							action_elem.unshift(elem);
						} else if (path[2].dataset.type === 'dialog') {
							action_elem[0].querySelector('textarea').maxLength = 65535;
						}
						path[1].append(...action_elem);
					}
				}
			} else if (path[0].dataset.type === 'delete') {
				const is_constraint_or_effect =
					/constraint|effect/.test(path[2].dataset.type);
				if (is_constraint_or_effect ||
					confirm(
						'Are you sure you want to delete this ' +
						(path[2].dataset.type === 'grab' ? 'pick up action' :
						path[2].dataset.type === 'dialog' ? 'talk to action' :
							path[2].dataset.type || 'game') +
						'? This operation cannot be undone.')) {
					const obj = { type: path[2].dataset.type || 'game' };
					if (is_constraint_or_effect) {
						if (['constraint', 'effect'].includes(path[2].dataset.type)) {
							if (!path[1].dataset.id) {
								path[1].remove();
								return;
							}
							const [, is_loc, id] = path[1].dataset.id.match(/^(l?)(\d+)$/);
							obj[is_loc ? 'loc' : 'obj'] = id;
						} else obj.obj = path[1].dataset.id;
						obj.item = path[3].dataset.id;
						obj.parenttype = path[3].classList.contains('description') ?
							'description' : path[4].dataset.type;
					} else {
						obj.id = path[1].dataset.id;
					}
					ajax('DELETE', '/remove', obj).catch(console.error);
					if (path[2].dataset.type === 'location') {
						document.querySelector('#game > ul[data-type="object"]').append(
							...path[1].querySelectorAll(
								'ul[data-type="object"] > li'));
					}
					if (path[2].dataset.type) path[1].remove();
					else window.location.replace('/');
				}
			} else if (path[0].dataset.type === 'add') {
				const ul = path[1].nextElementSibling;
				if (['object', 'location'].includes(ul.dataset.type)) {
					const name = prompt(
						`Choose a name for the ${ul.dataset.type}.`, '');
					if (!name) return;
					const text = name.toLowerCase();
					if (ul.dataset.type === 'location') {
						const { response } = await ajax('POST', '/add', {
							type: 'location', name
						});
						const elem = clone('location')[0];
						elem.dataset.id = response;
						elem.children[0].textContent = text;
						ul.append(elem);
						for (const select of document.querySelectorAll('.location-select')) {
							const option = document.createElement('option');
							option.value = response;
							option.text = text;
							select.append(option);
						}
						for (const select of document.querySelectorAll('.object-select')) {
							const optgroup = document.createElement('optgroup');
							optgroup.label = text;
							optgroup.dataset.id = response;
							select.append(optgroup);
						}
						create_datalist(`location-${response}-states`);
					} else if (ul.dataset.type === 'object') {
						const { response } = await ajax('POST', '/add', {
							type: 'object', name,
							location: path[2].dataset.id
						});
						const elem = clone('object')[0];
						elem.dataset.id = response;
						elem.children[0].textContent = text;
						ul.append(elem);
						for (const select of document.querySelectorAll('.object-select')) {
							const option = document.createElement('option');
							option.value = response;
							if (select.classList.contains('location-selectable')) {
								option.text = '   ' + text;
								select.insertBefore(option,
									select.querySelector(`[value="l${path[2].dataset.id}"] + *`));
							} else {
								option.text = text;
								(path[2].dataset.id ?
									select.querySelector(`[data-id="${path[2].dataset.id}"]`) :
									select).append(option);
							}
						}
						create_datalist(`object-${response}-states`);
					}
				} else {
					const { type } = path[1].nextElementSibling.dataset;
					const elem = clone(type)[0];
					const { response: id } = await ajax('POST', '/add', {
						type, item: path[2].dataset.id
					});
					elem.dataset.id = id;
					for (const element of elem.querySelectorAll('input[type="radio"]')) {
						element.name = `${type}-${id}`;
					}
					switch (type) {
						case 'action':
							elem.children[0].textContent =
								`use ${path[2].children[0].textContent} on `;
						break; case 'grab':
							elem.children[0].textContent =
								`pick up ${path[2].children[0].textContent}`;
							elem.querySelector('[data-type="success-checkbox"').checked = true;
						break; case 'dialog':
							elem.children[0].textContent =
								`talk to ${path[2].children[0].textContent}`;
					}
					path[1].nextElementSibling.append(elem);
					elem.querySelector('button').click();
				}
			} else if (path[3].classList.contains('add-button')) {
				path[4].querySelector(`ul[data-type="${path[0].dataset.type}"]`)
					.append(...clone(path[0].dataset.type));
			} else if (path[0].dataset.type === 'rename') {
				const link = path[1].querySelector('.link');
				const element = document.createElement('input');
				element.value = link.textContent;
				element.maxLength = 255;
				element.addEventListener('blur', event => {
					const text = element.value;
					ajax('POST', '/rename', {
						id: path[1].dataset.id,
						name: text,
						type: path[2].dataset.type
					});
					link.textContent = text;
					if (path[2].dataset.type === 'location') {
						for (const elem of document.querySelectorAll(
								`optgroup[data-id="${path[1].dataset.id}"]`)) {
							elem.label = text;
						}
						for (const elem of document.querySelectorAll(
								`option.group[value="l${path[1].dataset.id}"]`)) {
							elem.text = text;
						}
						for (const elem of document.querySelectorAll(
								`.location-select > option[value="${path[1].dataset.id}"]`)) {
							elem.text = text;
							if (elem.selected) {
								const path_names =
									elem.parentElement.parentElement.querySelector('.path-names');
								if (path_names) {
									for (let i = 0; i < 2; i++) {
										path_names.children[i].textContent = (i ? '' : 'to the ') + text;
									}
								}
							}
						}
					} else if (path[2].dataset.type === 'object') {
						for (const elem of document.querySelectorAll(
								`.object-select option[value="${path[1].dataset.id}"]`)) {
							elem.text = text;
						}
						for (const elem of path[1].querySelectorAll(
								`[data-type="action"] .link`)) {
							elem.textContent = `use ${text} on `;
						}
						for (const elem of path[1].querySelectorAll(
								`[data-type="grab"] .link`)) {
							elem.textContent = `pick up ${text}`;
						}
						for (const elem of path[1].querySelectorAll(
								`[data-type="dialog"] .link`)) {
							elem.textContent = `talk to ${text}`;
						}
					}
				});
				element.addEventListener('keypress', e => {
					if (e.key === 'Enter') e.target.blur();
				});
				link.textContent = '';
				link.appendChild(element);
				element.select();
			} else if (path[0].dataset.type === 'remove-description-part') {
				await ajax('DELETE', '/remove', {
					item: path[3].dataset.id,
					type: 'description',
					num: description_num(path[1])
				});
				path[1].nextElementSibling.remove();
				path[1].remove();
			} else if (path[0].dataset.type === 'add-description-part') {
				const [elem, plus] = clone('description');
				elem.dataset.id = (await ajax('POST', '/add', {
					item: path[3].dataset.id,
					type: 'description',
					num: description_num(path[1])
				})).response;
				path[2].insertBefore(plus, path[1].nextSibling);
				path[2].insertBefore(elem, plus);
			} else if (path[0].dataset.type === 'make-start') {
				await ajax('POST', '/setstart', { id: path[1].dataset.id });
				const old_start = document.querySelector('.start');
				if (old_start) {
					old_start.classList.remove('start');
					old_start.querySelector('[data-type="make-start"]').hidden = false;
				} else document.querySelector('iframe').contentWindow.location.reload();
				path[1].classList.add('start');
				path[0].hidden = true;
			} else if (path[1].classList.contains('names') ||
					path[1].classList.contains('path-names')) {
				const is_obj = path[1].classList.contains('names');
				if (path[0].querySelector('input')) return;
				await ajax('DELETE', '/remove', {
					type: is_obj ? 'name' : 'path-name',
					name: path[0].textContent,
					[is_obj ? 'obj' : 'path']: path[2].dataset.id
				});
				const elem = document.createElement('input');
				elem.value = path[0].textContent;
				elem.maxLength = 255;
				path[0].textContent = '';
				if (is_obj) {
					path[0].append(elem);
				} else {
					const span = document.createElement('span');
					span.append(elem);
					path[0].append(span);
				}
				elem.select();
				elem.addEventListener('blur', () => {
					if (elem.value) {
						ajax('POST', '/add', {
							type: is_obj ? 'name' : 'path-name',
							name: elem.value,
							[is_obj ? 'obj' : 'path']: path[2].dataset.id
						});
						path[0].textContent = elem.value.toLowerCase();
					} else path[0].remove();
				});
				elem.addEventListener('keypress', e => {
					if (e.key === 'Enter') e.target.blur();
				});
			}
		}
	});

	game_view.addEventListener('change', async event => {
		const path = event.composedPath();
		if (path[0] instanceof HTMLSelectElement) {
			if (/constraint|effect/.test(path[2].dataset.type)) {
				await change_constraint_or_effect(path);
			} else if (path[1].dataset.id) {
				await ajax('POST', '/change/item', {
					type: path[2].dataset.type,
					newitem: path[0].value,
					id: path[1].dataset.id
				});
				const path_names = path[1].querySelector('.path-names');
				if (path_names) {
					for (let i = 0; i < 2; i++) {
						path_names.children[i].hidden = path[0].selectedIndex < 1;
						path_names.children[i].textContent =
							(i ? '' : 'to the ') + path[0].options[path[0].selectedIndex].text;
					}
				}
			}
		} else if (path[0] instanceof HTMLTextAreaElement) {
			if (path[0].id === 'start-text') {
				await ajax('POST', '/change/start-text', {
					text: path[0].value
				});
			} else if (path[0].dataset.type === 'action-description') {
				await ajax('POST', '/change/description', {
					text: path[0].value,
					id: path[2].dataset.id,
					type: path[3].dataset.type
				});
			} else await ajax('POST', '/change/description', {
				text: path[0].value,
				id: path[1].dataset.id,
				type: 'location',
			});
		} else if (path[0] instanceof HTMLInputElement) {
			if (path[0].dataset.type === 'success-checkbox') {
				await ajax('POST', '/change/item', {
					id: path[2].dataset.id,
					state: path[0].checked,
					type: 'grab'
				});
			} else if (path[1].dataset.type === 'description-constraint' ||
				/constraint|effect/.test(path[2].dataset.type)) {
				await change_constraint_or_effect(path);
			} else if (/^(?:action|path|grab|dialog)$/.test(path[3].dataset.type)) {
				await ajax('POST', '/change/win', {
					id: path[2].dataset.id,
					type: path[3].dataset.type,
					value: path[0].value
				});
			} else if (path[1].classList.contains('names') ||
					path[2].classList.contains('path-names')) {
				const is_obj = path[1].classList.contains('names');
				await ajax('POST', '/add', {
					type: is_obj ? 'name' : 'path-name',
					[is_obj ? 'obj' : 'path']: path[3 - is_obj].dataset.id,
					name: path[0].value
				});
				const elem = document.createElement('button');
				elem.textContent = path[0].value.toLowerCase();
				path[2 - is_obj].insertBefore(elem, path[1 - is_obj]);
				path[0].value = '';
			}
		}
	});

	game_view.addEventListener('input', e => {
		if (['constraint', 'effect'].includes(e.composedPath()[2].dataset.type)) {
			e.target.classList[e.target.value === 'default' ? 'add' : 'remove']('default');
		}
	});

	{
		const frame = document.querySelector('iframe');
		
		frame.addEventListener('load', resize);

		document.querySelector('#super .location-selectable')
				.addEventListener('change', ({ target }) => {
			const select = target.nextElementSibling.nextElementSibling;
			select.options.length = 0;
			select.disabled = !target.value;
			if (target.value) {
				const [, is_location, id] = target.value.match(/(l?)(\d+)/);
				const { options } =	document.querySelector(
					`#${is_location ? 'location' : 'object'}-${id}-states`);
				for (const option of options) {
					select.append(option.cloneNode(true));
				}
			}
		});

		const dont_disable = document.querySelector('#super [data-type="move"] + *');
		document.querySelector('#super').addEventListener('change', ({ target }) => {
			if (dont_disable !== target) {
				target.parentElement.querySelector('button').disabled = !target.value;
			}
		});

		document.querySelector('#super').addEventListener('click', ({ target }) => {
			if (!(target instanceof HTMLButtonElement)) return;
			const input = frame.contentDocument.querySelector('input[name="gameState"]');
			let value;
			if (input) value = input.value
			else {
				if (frame.contentWindow.location.pathname === '/start') {
					if (target.datatset.type !== 'teleport') return;
					value = '';
				} else {
					value = new URL(frame.contentWindow.location).searchParams.get('gameState');
				}
			}
			const url = [`/super?gameState=${value}&type=${target.dataset.type}`];
			const elem = target.parentElement;
			if (target.dataset.type === 'state') {
				const [, is_location, id] = elem.querySelector('select').value.match(/(l?)(\d+)/);
				url.push(`${is_location ? 'loc' : 'obj'}=${id}&state=${
					encodeURIComponent(elem.querySelector('button + *').value)}`);
			} else {
				const loc = elem.querySelector('.location-select');
				const obj = elem.querySelector('.object-select');
				if (loc) url.push(`loc=${encodeURIComponent(loc.value)}`);
				if (obj) url.push(`obj=${encodeURIComponent(obj.value)}`);
			}
			frame.contentWindow.location = url.join('&');
		});
	}

	async function change_constraint_or_effect(path) {
		const obj = {
			item: path[3].dataset.id,
			type: path[2].dataset.type,
			parenttype: path[3].classList.contains('description') ?
				'description' : path[4].dataset.type
		}

		const inputs = path[1].querySelectorAll('select, input');

		if (['constraint', 'effect'].includes(path[2].dataset.type)) {
			if (path[0] === inputs[0]) {
				path[1].dataset.id = inputs[0].value;
				inputs[1].value = '';
				if (inputs[0].value) {
					inputs[1].disabled = false;
					const [, is_location, id] = inputs[0].value.match(/(l?)(\d+)/);
					inputs[1].setAttribute('list',
						`${is_location ? 'location' : 'object'}-${id}-states`);
				} else inputs[1].disabled = true;
				return;
			} else if (inputs[1].value === '') return;
			const [, is_location, id] = inputs[0].value.match(/(l?)(\d+)/);
			obj[is_location ? 'loc' : 'obj'] = id;
			if (path[1].dataset.id) await ajax('DELETE', '/remove', obj);
			if (inputs[1].value.toLowerCase() !== 'default') {
				add_state(inputs[1].value,
					`${is_location ? 'location' : 'object'}-${id}-states`);
			}
		} else if (path[1].dataset.id) {
			obj.obj = path[1].dataset.id;
			await ajax('DELETE', '/remove', obj);
		}

		if (path[2].dataset.type === 'inventory-constraint') {
			if (!inputs[1].value) return;
			path[1].dataset.id = inputs[1].value;
			obj.obj = inputs[1].value;
			obj.value = inputs[0].value;
		} else {
			try {
				if (!inputs[0].value ||
					!inputs[1].value && inputs[1] instanceof HTMLInputElement) return;
			} catch (e) { }
			path[1].dataset.id = inputs[0].value;
			if (!('loc' in obj)) obj.obj = inputs[0].value;
			if (inputs[1]) obj.value = inputs[1].value;
		}
		await ajax('POST', '/add', obj);
	}

	function resize({ target }) {
		target.height = 0;
		target.height =	target.contentDocument.documentElement.scrollHeight;
	}

	function description_num(element) {
		let item = element.previousElementSibling;
		let i = 0;
		while (item) {
			if (item instanceof HTMLDivElement) i++;
			item = item.previousElementSibling;
		}
		return i;
	}

	function ajax(method, url, query, type = 'json') {
		return new Promise((resolve, reject) => {
			const xhttp = new XMLHttpRequest();
			xhttp.responseType = type;
			xhttp.onreadystatechange = function () {
				if (this.readyState === 4) {
					(this.status < 400 ? resolve : reject)(this);
				}
			}
			let body = 'game=%s';
			for (const i in query) {
				if (query[i] !== undefined) {
					body += `&${encodeURIComponent(i)}=${encodeURIComponent(query[i])}`;
				}
			}
			xhttp.open(method, url + (method === "POST" ? '' : '?' + body), true);
			xhttp.send(method === "POST" ? body : undefined);
		});
	}

	function clone(type) {
		return [...document.querySelectorAll(`#${type} > *`)].map(e => e.cloneNode(true));
	}
</script>

</html>