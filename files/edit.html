<!DOCTYPE html>
<html lang='en'>

<head>
	<title>text adventure game</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		button {
			padding: 0;
		}

		button.link {
			font: inherit;
			line-height: 100%;
			background-color: transparent;
			cursor: pointer;
			border: 0;
			text-decoration: underline;
		}

		.nobullet {
			list-style: none;
		}

		li {
			line-height: 300%;
		}

		iframe {
			border: 1px solid black;
		}

		body {
			display: flex;
			flex-wrap: wrap;
		}
	</style>
</head>

<body>
	<div>
		<h3>Locations</h3>
		<ul class="location">
			<li class="nobullet"><button onclick='add(this.parentElement.parentElement)'>Add a location</button></li>
			%s
		</ul>
		<h3>Objects</h3>
		<ul class="object">
			<li class="nobullet"><button onclick='add(this.parentElement.parentElement)'>Add an object</button></li>
			%s
		</ul>
		<button onclick='remove(this)'>Delete this game</button>
		<p></p>
	</div>
	<iframe onload="this.height = this.contentWindow.document.body.scrollHeight + 24;"
		src="/start?game=%s"
		title="Play your game"></iframe>
</body>

<script>
	const game = '%d';
	var opened = new Set();

	function update_selects(elem) {
		var values = new Set();
		const selects = elem.getElementsByTagName('select');
		for (const select of selects) values.add(select.value);
		for (const select of selects) for (const option of select)
			if (option.value != 'null' && !option.selected)	option.hidden = values.has(option.value);
	}

	function expand(element) {
		if (opened.has(element)) {
			const lists = element.getElementsByTagName('ul');
			const textarea = element.getElementsByTagName('textarea');
			const show = !lists[0].hidden;
			if (textarea.length) textarea[0].hidden = show;
			for (const elem of lists) elem.hidden = show;
		} else {
			opened.add(element);
			const xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200)
					element.insertAdjacentHTML('beforeend', this.responseText);
			}
			xhttp.open("GET",
				"/expand?game=" + encodeURIComponent(game) +
				"&type=" + element.parentElement.classList[0] +
				"&id=" + element.classList[0], true);
			xhttp.send();
		}
	}

	function add(element) {
		const xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200)
				element.insertAdjacentHTML('beforeend', this.responseText);
			update_selects(element);
		}
		xhttp.open("POST", "/add", true);
		if (["action", "pick_up_action", "path", "constraint", "effect"].includes(element.classList[0])) {
			xhttp.send(
				"game=" + game +
				"&type=" + element.classList[0] +
				"&item=" + element.parentElement.classList[0] +
				"&parenttype=" + element.parentElement.parentElement.classList[0]);
		} else {
			const name = encodeURIComponent(prompt(`Choose a name for the ${element.classList[0]}.`, ""));
			if (name == "null" || name == "") return;
			if (element.classList[0] == "location") {
				const description = encodeURIComponent(prompt(`Choose a description for the location.`, ""));
				if (description == "null" || description == "") return;
				xhttp.send(
					"game=" + game +
					"&type=location&name=" + name +
					"&description=" + description);
			} else if (element.classList[0] == "object") {
				xhttp.send(
					"game=" + game +
					"&type=object&name=" + name +
					"&location=" + element.parentElement.classList[0]);
			}
		}
	}

	function remove(element) {
		var text =
			"Are you sure you want to delete this " +
			element.parentElement.classList[0] + "? This operation cannot be undone";
		if (confirm(text)) {
			const xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4) {
					if (this.status == 202) {
						element.remove();
					} else if (this.status == 410) {
						window.location.replace("/");
					}
				}
			}
			xhttp.open("DELETE",
				"/remove?game=" + game +
				"&type=" + element.parentElement.classList[0] +
				"&id=" + element.classList[0] +
				(['constraint', 'effect'].includes(element.parentElement.classList[0]) ?
					"&item=" + element.parentElement.parentElement.classList[0] +
					"&parenttype=" + element.parentElement.parentElement.parentElement.classList[0] : ''), true);
			xhttp.send();
		}
	}

	function rename(element) {
		const elem = element.getElementsByTagName('a')[0];
		const text = elem.innerHTML;
		elem.innerHTML = `<input value="${elem.innerText.replace(/\"/g, '&quot;')}" onblur="end_rename(this);" onkeypress="if (event.key == 'Enter') end_rename(this);">`;
		elem.getElementsByTagName('input')[0].select();
	}

	function end_rename(element) {
		const text = element.value;
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/rename", true);
		xhttp.send(
			"id=" + element.parentElement.parentElement.classList[0] +
			"&name=" + encodeURIComponent(text) +
			"&game=" + game +
			"&type=" + element.parentElement.parentElement.parentElement.classList[0]);
		element.outerHTML = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
	}

	function make_start(element) {
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", `/setstart`, true);
		xhttp.send(`id=${element.classList[0]}&game=${game}`);
		const old_start = document.getElementsByClassName('start')[0];
		old_start.classList.remove('start');
		old_start.getElementsByTagName("button")[2].hidden = false;
		element.classList.add('start');
		element.getElementsByTagName('button')[2].hidden = true;
	}

	function change_description(element) {
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/change/description", true);
		xhttp.send("game=" + game + 
			"&id=" + element.parentElement.classList[0] + 
			"&text=" + encodeURIComponent(element.value) +
			"&type=" + element.parentElement.parentElement.classList[0]);
	}

	function change_item(element) {
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", '/change/item', true);
		xhttp.send("game=" + game +
			"&type=" + element.parentElement.parentElement.classList[0] +
			"&id=" + element.parentElement.classList[0] +
			"&newitem=" + element.value);
	}

	function change_success(element) {
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", '/change/success', true);
		xhttp.send(`game=${game}&id=${element.parentElement.parentElement.classList[0]}&state=${element.checked ? 1 : 0}`);
	}

	async function change_constraint_or_effect(element) {
		if (element.classList[0] !== "NaN") {
			const xhttp = new XMLHttpRequest();
			xhttp.open("DELETE",
				"/remove?game=" + game +
				"&type=" + element.parentElement.classList[0] +
				"&id=" + element.classList[0] +
				"&item=" + element.parentElement.parentElement.classList[0] +
				"&parenttype=" + element.parentElement.parentElement.parentElement.classList[0], true);
			xhttp.send();
			await new Promise(resolve => xhttp.onreadystatechange = function() {if (this.readyState === 4) resolve()});
		}
		const xhttp = new XMLHttpRequest();
		xhttp.open("POST", '/add', true);
		xhttp.send(
			"game=" + game +
			"&obj=" + element.getElementsByTagName('select')[0].value +
			"&type=" + element.parentElement.classList[0] +
			"&item=" + element.parentElement.parentElement.classList[0] +
			"&parenttype=" + element.parentElement.parentElement.parentElement.classList[0] +
			"&state=" + element.getElementsByTagName('input')[0].value);
		element.className = element.getElementsByTagName('select')[0].value;
		update_selects(element.parentElement);
	}
</script>

</html>