<!DOCTYPE html>
<html lang='en'>

<head>
	<title>%s | Text Adventure Game Creator</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<link rel="stylesheet" href="navbar.css">
	<style>
		button {
			padding: 0;
		}

		.nobullet {
			list-style: none;
		}

		li {
			margin-top: 1em;
		}

		iframe {
			border: 1px solid black;
		}

		.container {
			display: flex;
			flex-wrap: wrap;
		}

		div.textarea {
			overflow-y: auto;
			border: 1px solid black;
			width: fit-content;
			height: 5em;
			resize: both;
			padding: 0.5em;
			margin-top: 1em;
		}

		textarea {
			height: auto;
			margin-top: 1em;
		}

		#join-link {
			text-decoration: underline;
		}

		.container > * {
			margin: 10px;
		}

		svg {
			height: 1em;
			width: 1em;
		}

		li > button:not(.link) {
			margin-left: 1em;
		}

		.location-selectable .group {
			font-weight: bold;
		}

		input.default {
			font-style: italic;
		}

		[data-type="names"] > button {
			margin: 0.5em;
			text-decoration: underline;
			cursor: pointer;
			background-color: transparent;
			border: 0;
			font: inherit;
		}

		[data-type="names"] {
			margin-top: 5px;
		}

		[data-type="names"]::before {
			content: "Alternate names:";
		}

		.add-button:not([hidden]) {
			display: flex;
		}

		.add-button > div {
			position: relative;
		}

		.add-button > div > div {
			display: none;
		}

		.add-button > button:hover + div > div,
		.add-button > div > div:hover {
			display: flex;
			flex-direction: column;
			position: absolute;
			top: -100%;
		}
	</style>
</head>

<body>
	%s
	<div class="container">
		<div id="game">
			<a href="/how-to-make-a-game" target="_blank" rel="noreferrer" title="How do I make a game?">
				<svg viewbox="0 0 20 20">
					<circle r=9 cx=10 cy=10 fill="white" stroke="black"/>
					<text dominant-baseline="middle" text-anchor="middle"
						x=10 y=11 style="font-size: 15px;">?</text>
				</svg>
			</a>
			<br>
			<textarea id="start-text">%s</textarea>
			<h3>Locations</h3>
			<ul data-type="location">
				<li class="nobullet"><button data-type="add">Add a location</button></li>
				%s
			</ul>
			<h3>Objects</h3>
			<ul data-type="object">
				<li class="nobullet"><button data-type="add">Add an object</button></li>
				%s
			</ul>
			<button data-type="delete">Delete this game</button>
		</div>
		<iframe src="/start?game=%s" title="Play your game"></iframe>
		%s
	</div>
	<div hidden>
		<div id="location">
			<li>
				<button class="link"></button>
				<button data-type="delete">delete</button>
				<button data-type="rename">rename</button>
				<button data-type="make-start">make start</button>
			</li>
		</div>
		<div id="object">
			<li>
				<button class="link"></button>
				<button data-type="delete">delete</button>
				<button data-type="rename">rename</button>
			</li>
		</div>
		<div id="constraint">
			<li>
				<select class="object-select location-selectable"></select>
				must be in state
				<input disabled size="10">
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="effect">
			<li>
				<select class="object-select location-selectable"></select>
				goes in state
				<input disabled size="10">
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="location-constraint">
			<li>
				<select class="object-select"></select>
				must be in <select class="location-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="location-effect">
			<li>
				<select class="object-select"></select>
				goes in <select class="location-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="inventory-constraint">
			<li>
				You
				<select class="noupdate">
					<option value="1">
						must have
					</option>
					<option value="0">
						must not have
					</option>
				</select>
				<select class="object-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="inventory-effect">
			<li>
				You get
				<select class="object-select"></select>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="expanded-location">
			<div class="textarea">
				<p>
					<button data-type="add-description-part">+</button>
				</p>
			</div>
			<ul data-type="object">
				<li class="nobullet">
					<button data-type="add">Add an object</button>
				</li>
			</ul>
			<ul data-type="path">
				<li class="nobullet">
					<button data-type="add">Add a path</button>
				</li>
			</ul>
		</div>
		<div id="expanded-object">
			<div data-type="names">
				<input>
			</div>
			<ul data-type="action">
				<li class="nobullet">
					<button data-type="add">Add an action</button>
				</li>
			</ul>
			<ul data-type="grab">
				<li class="nobullet">
					<button data-type="add">Add a pick up action</button>
				</li>
			</ul>
		</div>
		<div id="expanded-action">
			<p>
				<textarea data-type="action-description"></textarea>
			</p>
			<div class="add-button">
				<button>Add a constraint &gt;</button>
				<div>
					<div>
						<button data-type="constraint">Regular</button>
						<button data-type="location-constraint">Location</button>
						<button data-type="inventory-constraint">Inventory</button>
					</div>
				</div>
			</div>
			<div class="add-button" data-type="effect">
				<button>Add an effect &gt;</button>
				<div>
					<div>
						<button data-type="effect">Regular</button>
						<button data-type="location-effect">Location</button>
						<button data-type="inventory-effect">Inventory</button>
					</div>
				</div>
			</div>
			<ul data-type="constraint"></ul>
			<ul data-type="effect"></ul>
			<ul data-type="location-constraint"></ul>
			<ul data-type="location-effect"></ul>
			<ul data-type="inventory-constraint"></ul>
			<ul data-type="inventory-effect"></ul>
		</div>
		<div id="description">
			<div class="description">
				<div class="add-button">
					<button>Add a constraint &gt;</button>
					<div>
						<div>
							<button data-type="constraint">Regular</button>
							<button data-type="location-constraint">Location</button>
							<button data-type="inventory-constraint">Inventory</button>
						</div>
					</div>
				</div>
				<ul data-type="constraint"></ul>
				<ul data-type="location-constraint"></ul>
				<ul data-type="inventory-constraint"></ul>
				<textarea></textarea>
				<button data-type="remove-description-part">Delete</button>
			</div>
			<p><button data-type="add-description-part">+</button></p>
		</div>
		<div id="action">
			<li>
				<button class="link"></button>
				<select class="object-select"></select>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="grab">
			<li>
				<button class="link"></button>
				<label><input type="checkbox" data-type="success-checkbox">success</label>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
		<div id="path">
			<li>
				<button class="link">go to </button>
				<select class="location-select"></select>
				<label>
					<input type="radio" value="null" checked>
					Does not end game
				</label>
				<label>
					<input type="radio" value="1">
					You win
				</label>
				<label>
					<input type="radio" value="0">
					You lose
				</label>
				<button data-type="delete">delete</button>
			</li>
		</div>
	</div>
</body>

<script>
	'use strict';

	const game_view = document.getElementById('game');
	const opened = new WeakSet;

	const all_objects = {};
	all_objects.load = new Promise(resolve => all_objects.trigger = resolve);

	ajax('GET', '/all-objects').then(({ response }) => {
		all_objects.trigger();
		const selects = document.querySelectorAll('.object-select');
		for (const select of selects) select.append(document.createElement('option'));
		let current;
		for (const { id, name, loc_id, loc_name } of response) {
			if (current !== loc_id && loc_id !== null) {
				current = loc_id;
				for (const select of selects) {
					let elem;
					if (select.classList.contains('location-selectable')) {
						elem = document.createElement('option');
						elem.classList.add('group');
						elem.text = loc_name;
						elem.value = 'l'+loc_id;
					} else {
						elem = document.createElement('optgroup');
						elem.label = loc_name;
						elem.dataset.id = loc_id;
					}
					select.append(elem);
				}
				create_datalist(`location-${loc_id}-states`);
			}
			for (const select of selects) {
				const elem = document.createElement('option');
				elem.value = id;
				const location_selectable = select.classList.contains('location-selectable');
				elem.text = location_selectable && loc_id !== null ? '   ' + name : name;
				(loc_id === null || location_selectable ? select : select.lastChild).append(elem);
			}
			create_datalist(`object-${id}-states`);
		}

		ajax('GET', '/all-states').then(states => {
			for (const { name, obj, loc } of states.response) {
				add_state(name, obj ?
					`object-${obj}-states` : `location-${loc}-states`);
			}
		});
	});

	function create_datalist(id) {
		const datalist = document.createElement('datalist');
		const option = document.createElement('option');
		option.text = 'default';
		datalist.append(option);
		datalist.id = id;
		document.querySelector('body > div[hidden]').append(datalist);
	}

	function add_state(name, id) {
		if (name === null) return;
		const list = document.getElementById(id);
		for (const option of list.options) {
			if (option.text === name) return;
		}
		const elem = document.createElement('option');
		elem.text = name;			
		list.append(elem);
	}
 
	{
		const locations = document.querySelectorAll('ul[data-type="location"] > li:not(.nobullet)');
		for (const select of document.querySelectorAll('.location-select')) {
			select.append(document.createElement('option'));
			for (const location of locations) {
				const elem = document.createElement('option');
				elem.value = location.dataset.id;
				elem.text = location.children[0].textContent;
				select.append(elem);
			}
		}
	}

	game_view.addEventListener('click', async event => {
		const path = event.composedPath();
		if (path[0] instanceof HTMLButtonElement) {
			if (path[0].firstChild instanceof HTMLInputElement) return;
			if (path[0].classList.contains('link')) {
				if (opened.has(path[1])) {
					for (let i = 0, do_hide = false; i < path[1].childElementCount; i++) {
						if (!do_hide) {
							do_hide = path[1].children[i] instanceof HTMLDivElement ||
								path[1].children[i] instanceof HTMLParagraphElement;
						}
						if (do_hide) {
							path[1].children[i].hidden = !path[1].children[i].hidden;
						}
					}
				} else {
					opened.add(path[1]);
					const result = await ajax('GET', '/expand', {
						type: path[2].dataset.type,
						id: path[1].dataset.id
					});
					await all_objects.load;
					if (path[2].dataset.type === 'location') {
						const [description, objects, paths] = result.response;
						const location_elem = clone('expanded-location');
						for (const description_part of description) {
							const description_elem = clone('description');
							description_elem[0].dataset.id = description_part[0].id;
							description_elem[0].querySelector('textarea').value =
								description_part[0].text;
							for (const { obj, loc, name, loc_obj, location, inv_obj, have_it }
									of description_part) {
								if (obj || loc) {
									const elem = clone('constraint')[0];
									elem.querySelector('select').value = elem.dataset.id =
										obj || `l${loc}`;
									const input = elem.querySelector('input');
									if (name === null) {
										input.value = 'default';
										input.classList.add('default');
									} else input.value = name;
									input.disabled = false;
									input.setAttribute('list', obj ?
										`object-${obj}-states` : `location-${loc}-states`);
									description_elem[0].children[1].append(elem);
								}
								if (loc_obj) {
									const elem = clone('location-constriant')[0];
									elem.querySelector('.location-select').value =
										elem.dataset.id = loc_obj;
									elem.querySelector('.object-select').value = location;
									description_elem[0].children[2].append(elem);
								}
								if (inv_obj) {
									const elem = clone('inventory-constraint')[0];
									elem.querySelector('.object-select').value =
										elem.dataset.id = inv_obj;
									elem.querySelector('select').value = +have_it;
									description_elem[0].children[3].append(elem);
								}
							}
							location_elem[0].append(...description_elem);
						}

						for (const { name, id } of objects) {
							const elem = clone('object')[0];
							elem.dataset.id = id;
							elem.children[0].textContent = name;
							location_elem[1].append(elem);
						}

						for (const { id, end, win } of paths) {
							const elem = clone('path')[0];
							elem.dataset.id = id;
							elem.querySelector('.location-select').value = end;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `path-${id}`;
								if (input.value === String(win)) input.selected = true;
							}
							location_elem[2].append(elem);
						}
						path[1].append(...location_elem);
					} else if (path[2].dataset.type === 'object') {
						const [actions, grab, names] = result.response;
						const object_elem = clone('expanded-object');
						for (const { id, obj2, win } of actions) {
							const elem = clone('action')[0];
							elem.dataset.id = id;
							elem.querySelector('.link').textContent = `use ${path[0].textContent} on `;
							elem.querySelector('select').value = obj2;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `action-${id}`;
								if (input.value === String(win)) input.selected = true;
							}
							object_elem[1].append(elem);
						}
						for (const { id, success, win } of grab) {
							const elem = clone('grab')[0];
							elem.dataset.id = id;
							elem.querySelector('.link').textContent = `pick up ${path[0].textContent}`;
							if (success) elem.querySelector('input[type="checkbox"]').checked = true;
							for (const input of elem.querySelectorAll('input[type="radio"]')) {
								input.name = `grab-${id}`;
								if (input.value === String(win)) input.selected = true;
							}
							object_elem[2].append(elem);
						}
						for (const { name } of names) {
							const elem = document.createElement('button');
							elem.textContent = name;
							object_elem[0].insertBefore(elem, object_elem[0].lastElementChild);
						}

						path[1].append(...object_elem);
					} else {
						const [constraints, effects,
							location_constraints, location_effects,
							inventory_constraints, inventory_effects, text] = result.response;
						const action_elem = clone('expanded-action');
						action_elem[0].children[0].value = text;
						for (const is_constraint of [true, false]) {
							for (const { obj, loc, name }
									of is_constraint ? constraints : effects) {
								const elem = clone(is_constraint ? 'constraint' : 'effect')[0];
								elem.querySelector('select').value = elem.dataset.id =
									obj || 'l'+loc;
								const input = elem.querySelector('input');
								if (name === null) {
									input.value = 'default';
									input.classList.add('default');
								} else input.value = name;
								input.disabled = false;
								input.setAttribute('list', obj ?
									`object-${obj}-states` : `location-${loc}-states`);
								action_elem[is_constraint ? 3 : 4].append(elem);
							}
							for (const { obj, location } of location_constraints) {
								const elem = clone(`location-${
									is_constraint ? 'constraint' : 'effect'}`)[0];
								elem.dataset.id = obj;
								elem.querySelector('.object-select').value = obj;
								elem.querySelector('.location-select').value = location;
								action_elem[is_constraint ? 5 : 6].append(elem);
							}
						}
						for (const { obj, have_it } of inventory_constraints) {
							const elem = clone('inventory-constraint')[0];
							elem.dataset.id = obj;
							elem.querySelector('select').value = +have_it;
							elem.querySelector('.object-select').value = obj;
							action_elem[7].append(elem);
						}
						for (const { obj } of inventory_effects) {
							const elem = clone('inventory-effect')[0];
							elem.dataset.id = obj;
							elem.querySelector('.object-select').value = obj;
							action_elem[8].append(elem);
						}
						path[1].append(...action_elem);
					}
				}
			} else if (path[0].dataset.type === 'delete') {
				const is_constraint_or_effect =
					/constraint|effect/.test(path[2].dataset.type);
				if (is_constraint_or_effect ||
					confirm(
						'Are you sure you want to delete this ' +
						(path[2].dataset.type === 'grab' ?
							'pick up action' : path[2].dataset.type || 'game') +
						'? This operation cannot be undone.')) {
					const obj = { type: path[2].dataset.type || 'game' };
					if (is_constraint_or_effect) {
						if (['constraint', 'effect'].includes(path[2].dataset.type)) {
							if (!path[1].dataset.id) {
								path[1].remove();
								return;
							}
							const [, is_loc, id] = path[1].dataset.id.match(/^(l?)(\d+)$/);
							obj[is_loc ? 'loc' : 'obj'] = id;
						} else obj.obj = path[1].dataset.id;
						obj.item = path[3].dataset.id;
						obj.parenttype = path[3].classList.contains('description') ?
							'description' : path[4].dataset.type;
					} else {
						obj.id = path[1].dataset.id;
					}
					ajax('DELETE', '/remove', obj).catch(console.error);
					if (path[2].dataset.type === 'location') {
						document.querySelector('#game > ul[data-type="object"]').append(
							...path[1].querySelectorAll(
								'ul[data-type="object"] > li:not(.nobullet)'));
					}
					if (path[2].dataset.type) path[1].remove();
					else window.location.replace('/');
				}
			} else if (path[0].dataset.type === 'add') {
				if (['object', 'location'].includes(path[2].dataset.type)) {
					const name = prompt(
						`Choose a name for the ${path[2].dataset.type}.`, '');
					if (!name) return;
					const text = name.toLowerCase();
					if (path[2].dataset.type === 'location') {
						const { response } = await ajax('POST', '/add', {
							type: 'location', name
						});
						const elem = clone('location')[0];
						elem.dataset.id = response;
						elem.children[0].textContent = text;
						path[2].append(elem);
						for (const select of document.querySelectorAll('.location-select')) {
							const option = document.createElement('option');
							option.value = response;
							option.text = text;
							select.append(option);
						}
						for (const select of document.querySelectorAll('.object-select')) {
							const optgroup = document.createElement('optgroup');
							optgroup.label = text;
							optgroup.dataset.id = response;
							select.append(optgroup);
						}
						create_datalist(`location-${response}-states`);
					} else if (path[2].dataset.type === 'object') {
						const { response } = await ajax('POST', '/add', {
							type: 'object', name,
							location: path[3].dataset.id
						});
						const elem = clone('object')[0];
						elem.dataset.id = response;
						elem.children[0].textContent = text;
						path[2].append(elem);
						for (const select of document.querySelectorAll('.object-select')) {
							const option = document.createElement('option');
							option.value = response;
							if (select.classList.contains('location-selectable')) {
								option.text = '   ' + text;
								select.insertBefore(option,
									select.querySelector(`[value="l${path[3].dataset.id}"] + *`));
							} else {
								option.text = text;
								(path[3].dataset.id ?
									select.querySelector(`[data-id="${path[3].dataset.id}"]`) :
									select).append(option);
							}
						}
						create_datalist(`object-${response}-states`);
					}
				} else {
					const elem = clone(path[2].dataset.type)[0];
					elem.dataset.id = (await ajax('POST', '/add', {
						type: path[2].dataset.type,
						item: path[3].dataset.id
					})).response;
					switch (path[2].dataset.type) {
						case 'action':
							elem.children[0].textContent =
								`use ${path[3].children[0].textContent} on `;
						break; case 'grab':
							elem.children[0].textContent =
								`pick up ${path[3].children[0].textContent}`;
							elem.querySelector('[data-type="success-checkbox"').checked = true;
					}
					elem.querySelector('[value="null"]').selected = true;
					path[2].insertBefore(elem, path[1].nextSibling);
				}
			} else if (path[3].classList.contains('add-button')) {
				path[4].querySelector(`ul[data-type="${path[0].dataset.type}"]`)
					.append(...clone(path[0].dataset.type));
			} else if (path[0].dataset.type === 'rename') {
				const list = path[1].querySelector('.link');
				const element = document.createElement('input');
				element.value = list.textContent;
				element.addEventListener('blur', event => {
					const path = event.composedPath();
					const text = path[0].value;
					ajax('POST', '/rename', {
						id: path[2].dataset.id,
						name: text,
						type: path[3].dataset.type
					});
					path[1].textContent = text;
				});
				element.addEventListener('keypress', e => {
					if (e.key === 'Enter') e.target.blur();
				});
				list.textContent = '';
				list.appendChild(element);
				element.select();
			} else if (path[0].dataset.type === 'add-description-constraint') {
				path[2].insertBefore(clone(path[2].dataset.type)[0], path[1].nextSibling);
			} else if (path[0].dataset.type === 'remove-description-part') {
				await ajax('DELETE', '/remove', {
					item: path[3].dataset.id,
					type: 'description',
					num: description_num(path[1])
				});
				path[1].nextElementSibling.remove();
				path[1].remove();
			} else if (path[0].dataset.type === 'add-description-part') {
				const [elem, plus] = clone('description');
				elem.dataset.id = (await ajax('POST', '/add', {
					item: path[3].dataset.id,
					type: 'description',
					num: description_num(path[1])
				})).response;
				path[2].insertBefore(plus, path[1].nextSibling);
				path[2].insertBefore(elem, plus);
			} else if (path[0].dataset.type === 'make-start') {
				await ajax('POST', '/setstart', { id: path[1].dataset.id });
				const old_start = document.querySelector('.start');
				if (old_start) {
					old_start.classList.remove('start');
					old_start.querySelector('[data-type="make-start"]').hidden = false;
				} else document.querySelector('iframe').contentWindow.location.reload();
				path[1].classList.add('start');
				path[0].hidden = true;
			} else if (path[1].dataset.type === 'names') {
				await ajax('DELETE', '/remove', {
					type: 'name',
					name: path[0].textContent,
					obj: path[2].dataset.id
				});
				const elem = document.createElement('input');
				elem.value = path[0].textContent;
				path[0].textContent = '';
				path[0].append(elem);
				elem.select();
				elem.addEventListener('blur', () => {
					if (elem.value) {
						ajax('POST', '/add', {
							type: 'name',
							obj: path[2].dataset.id,
							name: elem.value
						});
						path[0].textContent = elem.value.toLowerCase();
					} else path[0].remove();
				});
				elem.addEventListener('keypress', e => {
					if (e.key === 'Enter') e.target.blur();
				});
			}
		}
	});

	game_view.addEventListener('change', async event => {
		const path = event.composedPath();
		if (path[0] instanceof HTMLSelectElement) {
			if (/constraint|effect/.test(path[2].dataset.type)) {
				await change_constraint_or_effect(path);
			} else if (path[1].dataset.id) await ajax('POST', '/change/item', {
				type: path[2].dataset.type,
				newitem: path[0].value,
				id: path[1].dataset.id
			});
		} else if (path[0] instanceof HTMLTextAreaElement) {
			if (path[0].id === 'start-text') {
				await ajax('POST', '/change/start-text', {
					text: path[0].value
				});
			} else if (path[0].dataset.type === 'action-description') {
				await ajax('POST', '/change/description', {
					text: path[0].value,
					id: path[2].dataset.id,
					type: path[3].dataset.type
				});
			} else await ajax('POST', '/change/description', {
				text: path[0].value,
				id: path[1].dataset.id,
				type: 'location',
			});
		} else if (path[0] instanceof HTMLInputElement) {
			if (path[0].dataset.type === 'success-checkbox') {
				await ajax('POST', '/change/item', {
					id: path[2].dataset.id,
					state: path[0].checked,
					type: 'grab'
				});
			} else if (path[1].dataset.type === 'description-constraint' ||
				/constraint|effect/.test(path[2].dataset.type)) {
				await change_constraint_or_effect(path);
			} else if (/^(?:action|path|grab)$/.test(path[3].dataset.type)) {
				await ajax('POST', '/change/win', {
					id: path[2].dataset.id,
					type: path[3].dataset.type,
					value: path[0].value
				});
			} else if (path[1].dataset.type === 'names') {
				await ajax('POST', '/add', {
					type: 'name',
					obj: path[2].dataset.id,
					name: path[0].value
				});
				const elem = document.createElement('button');
				elem.textContent = path[0].value.toLowerCase();
				path[1].insertBefore(elem, path[0]);
				path[0].value = '';
			}
		}
	});

	game_view.addEventListener('input', e => {
		if (['constraint', 'effect'].includes(e.composedPath()[2].dataset.type)) {
			e.target.classList[e.target.value === 'default' ? 'add' : 'remove']('default');
		}
	});

	document.querySelector('iframe').addEventListener('load', resize);

	async function change_constraint_or_effect(path) {
		const obj = {
			item: path[3].dataset.id,
			type: path[2].dataset.type,
			parenttype: path[3].classList.contains('description') ?
				'description' : path[4].dataset.type
		}

		const inputs = path[1].querySelectorAll('select, input');
		
		if (['constraint', 'effect'].includes(path[2].dataset.type)) {
			if (path[0] === inputs[0]) {
				path[1].dataset.id = inputs[0].value;
				inputs[1].value = '';
				if (inputs[0].value) {
					inputs[1].disabled = false;
					const [, is_location, id] = inputs[0].value.match(/(l?)(\d+)/);
					inputs[1].setAttribute('list',
						`${is_location ? 'location' : 'object'}-${id}-states`);
				} else inputs[1].disabled = true;
				return;
			} else if (inputs[1].value === '') return;
			const [, is_location, id] = inputs[0].value.match(/(l?)(\d+)/);
			obj[is_location ? 'loc' : 'obj'] = id;
			if (path[1].dataset.id) await ajax('DELETE', '/remove', obj);
			if (inputs[1].value.toLowerCase() !== 'default') {
				add_state(inputs[1].value,
					`${is_location ? 'location' : 'object'}-${id}-states`);
			}
		} else if (path[1].dataset.id) {
			obj.obj = path[1].dataset.id;
			await ajax('DELETE', '/remove', obj);
		}

		if (path[2].dataset.type === 'inventory-constraint') {
			if (!inputs[1].value) return;
			path[1].dataset.id = inputs[1].value;
			obj.obj = inputs[1].value;
			obj.value = inputs[0].value;
		} else {
			try {
				if (!inputs[0].value || !inputs[1].value) return;
			} catch (e) { }
			path[1].dataset.id = inputs[0].value;
			obj.obj = inputs[0].value;
			if (inputs[1]) obj.value = inputs[1].value;
		}
		await ajax('POST', '/add', obj);
	}

	function resize({ target }) {
		target.height = 0;
		target.height =	target.contentDocument.documentElement.scrollHeight;
	}

	function description_num(element) {
		let item = element.previousElementSibling;
		let i = 0;
		while (item) {
			if (item instanceof HTMLDivElement) i++;
			item = item.previousElementSibling;
		}
		return i;
	}

	function ajax(method, url, query, type = 'json') {
		return new Promise((resolve, reject) => {
			const xhttp = new XMLHttpRequest();
			xhttp.responseType = type;
			xhttp.onreadystatechange = function () {
				if (this.readyState === 4) {
					(this.status < 400 ? resolve : reject)(this);
				}
			}
			let body = 'game=%s';
			for (const i in query) {
				if (query[i] !== undefined) {
					body += `&${encodeURIComponent(i)}=${encodeURIComponent(query[i])}`;
				}
			}
			xhttp.open(method, url + (method === "POST" ? '' : '?' + body), true);
			xhttp.send(method === "POST" ? body : undefined);
		});
	}

	function clone(type) {
		return [...document.querySelectorAll(`#${type} > *`)].map(e => e.cloneNode(true));
	}
</script>

</html>